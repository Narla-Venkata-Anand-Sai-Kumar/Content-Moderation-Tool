(function(){"use strict";const F={status:!0,blurryStartMode:!1,blurAmount:20,blurImages:!0,blurVideos:!0,blurMale:!1,blurFemale:!0,unblurImages:!1,unblurVideos:!1,gray:!0,strictness:.5},h={ERROR:"-1ERROR",OBSERVED:"0OBSERVED",QUEUED:"1QUEUED",LOADING:"2LOADING",LOADED:"3LOADED",PROCESSING:"4PROCESSING",PROCESSED:"5PROCESSED",DISABLED:"9DISABLED"},U=300,P=400,v=32,$=32,x=1920/4.5,W=1080/4.5,k=async t=>await new Promise((e,s)=>{t.setAttribute("crossorigin","anonymous"),t.readyState>=3&&t.videoHeight&&e(!0),t.onloadeddata=()=>{t.videoHeight?e(!0):s()},t.onerror=r=>{s("Failed to load video",t)}}),L=t=>t.width<v||t.height<$,j=(t,e,s="image")=>{let r=t,i=e;if(!t||!e)return{newWidth:r,newHeight:i};let a=s==="image"?P:x,n=s==="image"?U:W;if(r<i){const o=a;a=n,n=o}if(!(r<a&&i<n)){const o=Math.min(a/r,n/i);r=r*o,i=i*o}return{newWidth:r,newHeight:i}},q=(t,e)=>{var i,a;const s=((i=t==null?void 0:t.getElementsByTagName)==null?void 0:i.call(t,"img"))??[],r=((a=t==null?void 0:t.getElementsByTagName)==null?void 0:a.call(t,"video"))??[];for(let n=0;n<s.length+r.length;n++){const o=n<s.length?s[n]:r[n-s.length];o.tagName==="VIDEO"?e(o):o.tagName==="IMG"&&(o.complete&&L(o)&&o.naturalHeight||e(o))}(t.tagName==="IMG"||t.tagName==="VIDEO")&&e(t)},p=(t,e="")=>{const s=new CustomEvent(t,{detail:e});document.dispatchEvent(s)},f=(t,e)=>{document.addEventListener(t,e)},X=(t,e,s=!0)=>{let r;return s?r=new OffscreenCanvas(t,e):(r=document.getElementById("hb-in-canvas")??document.createElement("canvas"),r.id="hb-in-canvas",r.width=t,r.height=e,r.parentElement||document.body.appendChild(r)),r},Q=t=>{t.dataset.HBstatus=h.DISABLED,t.classList.remove("hb-blur")},z=t=>{t.dataset.HBstatus=h.PROCESSING};function Y(t){const e=t.filter(s=>s.dataset.HBstatus===h.DISABLED&&!s.paused&&s.currentTime>0)??[];chrome.runtime.sendMessage({type:"video-status",status:e.length===0})}const Z=window.requestIdleCallback||function(t){var e=Date.now();return setTimeout(function(){t({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},O=7e3;let g,c,u;const M=({detail:t})=>{u=t,g=document.createElement("style"),g.id="hb-stylesheet",document.head.appendChild(g),J()},J=()=>{!u.shouldDetect()||!u.isBlurryStartMode()||(c=document.createElement("style"),c.id="hb-blurry-start-stylesheet",c.innerHTML=`
	  img, video{
		filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"grayscale(100%)":""} !important;
		transition: filter 0.1s ease !important;
		opacity: unset !important;
	  }

	  img:hover, video:hover{
		filter: blur(0px) ${u.isGray()?"grayscale(0%)":""} !important;
		transition: filter 0.5s ease !important;
		transition-delay: 0.5s !important;
	  }
	`,document.head.appendChild(c),setTimeout(()=>{c!=null&&c.innerHTML&&p("blurryStartModeTimeout","timeout")},O))},D=({detail:t})=>{if(u=t,g||M(),!u.shouldDetect()){g.innerHTML="";return}const e=u.shouldBlurImages(),s=u.shouldBlurVideos(),r=u.shouldUnblurImages(),i=u.shouldUnblurVideos();let a=[];e&&a.push("img.hb-blur"),s&&a.push("video.hb-blur"),a=a.join(", ");let n=[];r&&n.push("img.hb-blur:hover"),i&&n.push("video.hb-blur:hover"),n=n.join(", "),g.innerHTML=`
    ${a} {
      filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"grayscale(100%)":""} !important;
      transition: filter 0.1s ease !important;
      opacity: unset !important;
    }
	
  `,n&&(g.innerHTML+=`
		${n} {
			filter: blur(0px) ${u.isGray()?"grayscale(0%)":""} !important;
			transition: filter 0.5s ease !important;
			transition-delay: 1s !important;
		  }
	`),g.innerHTML+=`
	.hb-blur-temp { 
		animation: hb-blur-temp ${O}ms ease-in-out forwards !important;
	}

	#hb-in-canvas {
		display: none !important;
		visibility: hidden !important;
	}

	@keyframes hb-blur-temp {
		0% { filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"grayscale(100%)":""}; }
		95% { filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"grayscale(100%)":""}; }
		100% { filter: blur(0px) ${u.isGray()?"grayscale(0%)":""}; }
	}
  `},T=t=>{c!=null&&c.innerHTML&&(c.innerHTML="")},K=t=>{u!=null&&u.isBlurryStartMode()&&t.classList.add("hb-blur-temp")},A=t=>{t.classList.remove("hb-blur-temp")},tt=()=>{f("settingsLoaded",M),f("toggleOnOffStatus",D),f("changeBlurAmount",D),f("changeGray",D),f("detectionStarted",T),f("blurryStartModeTimeout",T)},et=1e3/25,C=1,st=4,b={CLEAR:"CLEAR",NSFW:"NSFW",FACE:"FACE",ERROR:"ERROR"};let _=0,w=0,E=!1,B=!1,m,y;const G=()=>{E||(w>=_/8&&!E&&(E=!0,console.log("HaramBlur: Detection started"),p("detectionStarted")),w++)},rt=(t,e)=>{try{t.dataset.HBstatus=e.PROCESSING,!E&&_++,chrome.runtime.sendMessage({type:"imageDetection",image:{src:t.src,width:t.width||t.naturalWidth,height:t.height||t.naturalHeight}},s=>{G(),A(t),(s==="face"||s==="nsfw"||s==!1)&&(t.dataset.HBstatus=e.PROCESSED,(s==="face"||s==="nsfw")&&(t.classList.add("hb-blur"),t.dataset.HBresult=s))})}catch(s){console.log("HB==ERROR",s)}},at=async(t,{width:e,height:s})=>new Promise((r,i)=>{(!m||m.width!==e||m.height!==s)&&(m=null,m=X(e,s),y=m.getContext("2d",{willReadFrequently:!0})),y.clearRect(0,0,e,s),y.drawImage(t,0,0,e,s),m.convertToBlob({type:"image/png"}).then(a=>{let n=URL.createObjectURL(a);chrome.runtime.sendMessage({type:"videoDetection",frame:{data:n,timestamp:t.currentTime}},o=>{URL.revokeObjectURL(n),r(o)})})}),H=async(t,{width:e,height:s})=>{const r=performance.now();t.dataset.HBprevTime||(t.dataset.HBprevTime=r);const i=r-t.dataset.HBprevTime;if(t.dataset.HBstatus===h.DISABLED&&t.classList.remove("hb-blur"),!t.paused&&t.dataset.HBstatus!==h.DISABLED)try{i>=et&&(t.dataset.HBprevTime=r,B||(B=!0,at(t,{width:e,height:s}).then(({result:a,timestamp:n})=>{if(a==="error")throw new Error("HB==Error in processFrame");a!=="skipped"&&(t.currentTime-n>.5||it(a,t))}).catch(a=>{throw a}).finally(()=>{B=!1})))}catch(a){console.log("HB==Video detection loop error",a,t),t.dataset.HBerrored=parseInt(t.dataset.HBerrored??0)+1}if(t.dataset.HBerrored>10){t.onplay=null,cancelAnimationFrame(t.dataset.HBrafId),t.removeAttribute("crossorigin");return}t.paused?t.onplay=()=>{t.dataset.HBrafId=requestAnimationFrame(()=>H(t,{width:e,height:s}))}:t.dataset.HBrafId=requestAnimationFrame(()=>H(t,{width:e,height:s}))},nt=async(t,e)=>{try{t.dataset.HBstatus=e.LOADING,await k(t),t.dataset.HBstatus=e.PROCESSING;const{newWidth:s,newHeight:r}=j(t.videoWidth??t.width,t.videoHeight??t.height,"video");G(),A(t),Z(()=>{H(t,{width:s,height:r})},{timeout:1e3})}catch(s){console.log("HB== processVideo error",s)}},it=(t,e)=>{const s=e.dataset.HBresult,r=s===b.CLEAR||!s,i=parseInt(e.dataset.positiveCount??0),a=parseInt(e.dataset.negativeCount??0);let n=null;t==="nsfw"?(e.dataset.HBresult=b.NSFW,e.dataset.positiveCount=i+!r,e.dataset.negativeCount=0,i+!r>=C&&(n=!0,e.dataset.positiveCount=0)):t==="face"?(e.dataset.HBresult=b.FACE,e.dataset.positiveCount=i+!r,e.dataset.negativeCount=0,i+!r>=C&&(n=!0,e.dataset.positiveCount=0)):(e.dataset.HBresult=b.CLEAR,e.dataset.negativeCount=a+r,e.dataset.positiveCount=0,a+r>=st&&(n=!1,e.dataset.negativeCount=0)),n!==null&&(n?e.classList.add("hb-blur"):e.classList.remove("hb-blur"))};let l,d,I=[];const S=()=>{l||N(),l==null||l.observe(document,{childList:!0,characterData:!1,subtree:!0,attributes:!0,attributeFilter:["src"]})},N=()=>{l=new MutationObserver(t=>{t.forEach(e=>{if(e.type==="childList")e.addedNodes.forEach(s=>{q(s,r=>{V(r,!1)})});else if(e.type==="attributes"){const s=e.target;V(s,(e==null?void 0:e.attributeName)==="src")}})}),S()},ut=()=>{f("settingsLoaded",({detail:t})=>{d=t,d.shouldDetect()?l||S():(l==null||l.disconnect(),l=null)}),f("toggleOnOffStatus",()=>{d!=null&&d.shouldDetect()?l||S():(l==null||l.disconnect(),l=null)}),chrome.runtime.onMessage.addListener((t,e,s)=>(t.type==="disable-detection"?I.filter(r=>r.dataset.HBstatus===h.PROCESSING&&!r.paused&&r.currentTime>0).forEach(r=>{Q(r)}):t.type==="enable-detection"&&I.filter(r=>r.dataset.HBstatus===h.DISABLED&&!r.paused&&r.currentTime>0).forEach(r=>{z(r)}),!0))};function V(t,e){var r,i,a;!(t.tagName==="IMG"&&(!d||d.shouldDetectImages())||t.tagName==="VIDEO"&&(!d||d.shouldDetectVideos()))||!((e||!t.dataset.HBstatus)&&((r=t.src)==null?void 0:r.length)>0&&(!L(t)||t.height===0||t.width===0))||(K(t),t.dataset.HBstatus=h.OBSERVED,(i=t.src)!=null&&i.length?t.tagName==="IMG"?rt(t,h):t.tagName==="VIDEO"&&(nt(t,h),I.push(t),Y(I)):(a=t.dataset)==null||delete a.HBstatus)}class R{constructor(e=F){this._settings=e}shouldDetectMale(){return this._settings.status?this._settings.blurMale:!1}shouldDetectFemale(){return this._settings.status?this._settings.blurFemale:!1}shouldDetectGender(){return this._settings.status?this.shouldDetectMale()||this.shouldDetectFemale():!1}shouldDetectImages(){return this._settings.status?this._settings.blurImages:!1}shouldDetectVideos(){return this._settings.status?this._settings.blurVideos:!1}shouldBlurImages(){return this.shouldDetectImages()}shouldBlurVideos(){return this.shouldDetectVideos()}shouldUnblurImages(){return this._settings.status?this._settings.unblurImages:!1}shouldUnblurVideos(){return this._settings.status?this._settings.unblurVideos:!1}shouldDetect(){return!this._settings.status||!this.shouldDetectImages()&&!this.shouldDetectVideos()?!1:this.shouldDetectGender()}isBlurryStartMode(){return this.shouldDetect()?this._settings.blurryStartMode:!1}getBlurAmount(){return this.shouldDetect()?this._settings.blurAmount:0}getStrictness(){return this.shouldDetect()?this._settings.strictness:0}isGray(){return this.shouldDetect()?this._settings.gray:!1}getSettings(){return this._settings}setSettings(e){this._settings=e}toggleOnOffStatus(){p("toggleOnOffStatus",this)}listenForChanges(){chrome.runtime.onMessage.addListener((e,s,r)=>(e.type==="updateSettings"&&this.updateSettings(e.newSetting),!0))}static async init(){const e=await new Promise(r=>{chrome.runtime.sendMessage({type:"getSettings"},i=>{r(i)})}),s=new R(e);return s.listenForChanges(),p("settingsLoaded",s),s}updateSettings(e){const{key:s,value:r}=e;switch(this._settings[s]=r,s){case"status":this.toggleOnOffStatus();break;case"blurAmount":p("changeBlurAmount",this);break;case"gray":p("changeGray",this);break}}}const lt=()=>{tt(),ut()};window.self===window.top&&(lt(),N(),R.init().then(t=>{t.toggleOnOffStatus()}).catch(t=>{console.log("HB==INITIALIZATION ERROR",t)}))})();
